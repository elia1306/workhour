<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧工時表 (含請假時數計算)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #2980b9;
            --holiday: #c0392b;
            --holiday-bg: #fadbd8;
            --leave-bg: #e8f6f3; /* 請假時的背景色 */
            --bg: #f5f7fa;
        }

        body {
            font-family: '微軟正黑體', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 950px; /* 加寬一點以容納新欄位 */
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header { text-align: center; margin-bottom: 20px; }
        
        .status-badge {
            font-size: 0.8em; padding: 4px 8px; border-radius: 12px;
            background: #eee; color: #666; vertical-align: middle;
        }
        .status-ok { background: #d4edda; color: #155724; }
        .status-err { background: #f8d7da; color: #721c24; }

        .control-panel {
            background-color: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;
            display: flex; flex-wrap: wrap; gap: 20px; align-items: center;
            border-left: 5px solid var(--accent);
        }

        .control-group { display: flex; flex-direction: column; }
        label { font-size: 0.9em; color: #666; margin-bottom: 5px; font-weight: bold;}
        select, input[type="date"], input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        button {
            padding: 8px 15px; background-color: var(--accent); color: white;
            border: none; border-radius: 4px; cursor: pointer;
        }
        button:hover { opacity: 0.9; }
        .btn-danger { background-color: #e74c3c; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 12px 6px; text-align: center; border-bottom: 1px solid #eee; }
        th { background-color: var(--primary); color: white; }
        
        .date-display { display: block; font-size: 0.8em; color: #7f8c8d; }
        
        /* 樣式狀態 */
        tr.is-holiday { background-color: var(--holiday-bg); }
        tr.is-holiday .holiday-tag { color: var(--holiday); font-weight: bold; font-size: 0.9em; display: block; }
        
        /* 當有輸入請假時數時的樣式 */
        tr.has-leave { background-color: var(--leave-bg); }

        input[type="time"] { padding: 6px; border: 1px solid #ddd; border-radius: 4px; width: 100px; }
        
        /* 請假時數輸入框 */
        input.leave-input { 
            width: 60px; padding: 6px; border: 1px solid #3498db; 
            border-radius: 4px; text-align: center; color: #2980b9; font-weight: bold;
        }

        input[type="checkbox"] { transform: scale(1.5); cursor: pointer; }

        .summary-box {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;
            background-color: var(--secondary); color: white; padding: 20px; border-radius: 8px;
        }
        .summary-item div:first-child { font-size: 0.9em; opacity: 0.8; }
        .summary-item div:last-child { font-size: 1.5em; font-weight: bold; margin-top: 5px; }
        .highlight { color: #f1c40f; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 style="display:inline-block; margin:0;">工時管理 (含請假計算)</h2>
        <span id="apiStatus" class="status-badge">檢查假日資料中...</span>
    </div>

    <div class="control-panel">
        <div class="control-group">
            <label>選擇人員</label>
            <div style="display:flex; gap:5px;">
                <select id="userSelect" onchange="switchUser()"></select>
                <button onclick="addNewUser()">+</button>
                <button class="btn-danger" onclick="deleteUser()">-</button>
            </div>
        </div>

        <div class="control-group">
            <label>本週開始日期 (週一)</label>
            <input type="date" id="weekStartDate" onchange="handleWeekChange()">
        </div>
        
        <div class="control-group" style="justify-content:end; margin-left:auto;">
             <button onclick="forceUpdateHolidays()" style="background:#27ae60;">↻ 更新假日</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th width="15%">日期</th>
                <th width="18%">上班</th>
                <th width="18%">下班</th>
                <th width="10%">午休</th>
                <th width="12%">請假(時)</th>
                <th width="8%">全日假</th>
                <th width="19%">總工時</th>
            </tr>
        </thead>
        <tbody id="timesheetBody"></tbody>
    </table>

    <div class="summary-box">
        <div class="summary-item">
            <div>本週累計 (含請假)</div>
            <div id="totalHours">0.00</div>
        </div>
        <div class="summary-item">
            <div>距離 40H 還差</div>
            <div id="remainingHours">0.00</div>
        </div>
        <div class="summary-item">
            <div>週五建議下班</div>
            <div id="predictTime" class="highlight">--:--</div>
        </div>
    </div>
</div>

<script>
    // --- 1. 設定與變數 ---
    const LUNCH_START = 12 * 60;
    const LUNCH_END = 13 * 60;
    const TARGET_HOURS = 40;
    const HOLIDAY_API_URL = "https://cdn.jsdelivr.net/gh/ruyut/taiwan-calendar-json/data/";

    let users = JSON.parse(localStorage.getItem('worklog_users')) || ['預設人員'];
    let currentUser = users[0];
    let holidayCache = {};

    window.onload = async function() {
        initUserSelect();
        setDefaultDate();
        const year = new Date().getFullYear();
        await loadHolidaysForYear(year);
        handleWeekChange();
    };

    // --- 2. 假日資料處理 (API) ---
    async function loadHolidaysForYear(year) {
        const localKey = `holidays_${year}`;
        const localData = localStorage.getItem(localKey);
        
        if (holidayCache[year]) return;
        
        if (localData) {
            holidayCache[year] = JSON.parse(localData);
            updateStatus(true, `${year} 資料已載入`);
            return;
        }

        updateStatus(false, `下載 ${year} 資料...`);
        try {
            const response = await fetch(`${HOLIDAY_API_URL}${year}.json`);
            if (!response.ok) throw new Error("無資料");
            const data = await response.json();
            const processed = {};
            data.forEach(item => {
                if (item.isHoliday) {
                    const dStr = item.date + ""; 
                    const key = `${dStr.substring(4,6)}-${dStr.substring(6,8)}`;
                    processed[key] = item.description || "國定假日";
                }
            });
            holidayCache[year] = processed;
            localStorage.setItem(localKey, JSON.stringify(processed));
            updateStatus(true, `${year} 資料更新`);
        } catch (e) {
            console.error(e);
            updateStatus(false, `無法抓取 ${year}`, true);
            holidayCache[year] = {}; 
        }
    }

    function updateStatus(isOk, text, isError = false) {
        const badge = document.getElementById('apiStatus');
        badge.textContent = text;
        badge.className = 'status-badge ' + (isError ? 'status-err' : (isOk ? 'status-ok' : ''));
    }
    
    async function forceUpdateHolidays() {
        const year = document.getElementById('weekStartDate').value.substring(0, 4);
        localStorage.removeItem(`holidays_${year}`);
        delete holidayCache[year];
        await loadHolidaysForYear(year);
        renderTable();
        loadUserData();
    }
    
    function getHolidayName(dateStr) {
        const year = dateStr.substring(0, 4);
        const md = dateStr.substring(5, 10);
        if (!holidayCache[year]) return null;
        return holidayCache[year][md] || null;
    }

    // --- 3. 表格與計算核心 ---
    async function handleWeekChange() {
        const dateInput = document.getElementById('weekStartDate');
        if(!dateInput.value) return;
        const y = dateInput.value.substring(0, 4);
        if (!holidayCache[y]) await loadHolidaysForYear(y);
        renderTable();
        loadUserData();
    }

    function renderTable() {
        const tbody = document.getElementById('timesheetBody');
        tbody.innerHTML = '';
        const weekStartVal = document.getElementById('weekStartDate').value;
        const startDate = new Date(weekStartVal);
        const days = ['週一', '週二', '週三', '週四', '週五'];

        for (let i = 0; i < 5; i++) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + i);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');
            const dateStr = `${y}-${m}-${day}`;
            const holidayName = getHolidayName(dateStr);

            const tr = document.createElement('tr');
            tr.id = `day-${i}`;
            tr.dataset.date = dateStr;

            let holidayText = holidayName ? `<span class="holiday-tag">${holidayName}</span>` : '';
            let checkedAttr = holidayName ? 'checked' : '';

            // 這裡加入 "請假時數" 的 input
            tr.innerHTML = `
                <td>${days[i]} <span class="date-display">${dateStr}</span>${holidayText}</td>
                <td><input type="time" class="start-time" value="09:00" onchange="calculate()"></td>
                <td><input type="time" class="end-time" value="18:00" onchange="calculate()"></td>
                <td style="font-size:0.8em; color:#666;">-1H</td>
                <td><input type="number" class="leave-input" min="0" max="8" step="0.5" value="" placeholder="0" onchange="calculate()"></td>
                <td><input type="checkbox" class="holiday-check" ${checkedAttr} onchange="calculate()"></td>
                <td class="daily-hours">0.00 H</td>
            `;
            tbody.appendChild(tr);
        }
    }

    function calculate() {
        saveUserData();
        let totalMinutes = 0;
        let minsBeforeFri = 0; // 週一到週四的累積 (包含請假)
        
        const rows = document.querySelectorAll('#timesheetBody tr');
        
        rows.forEach((row, index) => {
            const sVal = timeToMin(row.querySelector('.start-time').value);
            const eVal = timeToMin(row.querySelector('.end-time').value);
            const leaveVal = parseFloat(row.querySelector('.leave-input').value) || 0; // 取得請假時數
            const isFullDayHoliday = row.querySelector('.holiday-check').checked;
            const display = row.querySelector('.daily-hours');

            // 狀態判定
            let dailyWorkMins = 0;
            let dailyTotalMins = 0;

            if (isFullDayHoliday) {
                // 全日假 (國定假日或特休)
                row.classList.add('is-holiday');
                row.classList.remove('has-leave');
                dailyTotalMins = 480; // 固定 8 小時
                display.textContent = "8.00 H (假)";
                
                // 鎖定輸入
                row.querySelector('.start-time').disabled = true;
                row.querySelector('.end-time').disabled = true;
                row.querySelector('.leave-input').disabled = true;
                row.querySelector('.start-time').style.opacity = 0.5;
            } else {
                // 非全日假，計算工時 + 部分請假
                row.classList.remove('is-holiday');
                row.querySelector('.start-time').disabled = false;
                row.querySelector('.end-time').disabled = false;
                row.querySelector('.leave-input').disabled = false;
                row.querySelector('.start-time').style.opacity = 1;

                // 樣式：如果有請假時數
                if (leaveVal > 0) {
                    row.classList.add('has-leave');
                } else {
                    row.classList.remove('has-leave');
                }

                // 1. 計算打卡工時
                if (sVal !== null && eVal !== null) {
                    dailyWorkMins = calcNetWork(sVal, eVal);
                }
                
                // 2. 加上請假時數 (轉分鐘)
                const leaveMins = leaveVal * 60;
                
                dailyTotalMins = dailyWorkMins + leaveMins;
                
                // 顯示邏輯
                if (dailyTotalMins > 0) {
                    let text = (dailyTotalMins / 60).toFixed(2) + " H";
                    if(leaveVal > 0) {
                        text += ` (含${leaveVal}假)`;
                    }
                    display.textContent = text;
                } else {
                    display.textContent = "--";
                }
            }

            totalMinutes += dailyTotalMins;
            if (index < 4) {
                minsBeforeFri += dailyTotalMins;
            }
        });

        // 更新總計
        document.getElementById('totalHours').textContent = (totalMinutes/60).toFixed(2) + " H";
        const remain = Math.max(0, TARGET_HOURS*60 - totalMinutes);
        document.getElementById('remainingHours').textContent = (remain/60).toFixed(2) + " H";
        
        // --- 週五預測邏輯 ---
        const friRow = rows[4];
        const friFullHoliday = friRow.querySelector('.holiday-check').checked;
        const friStart = friRow.querySelector('.start-time').value;
        const friLeave = parseFloat(friRow.querySelector('.leave-input').value) || 0; // 週五打算請假多久
        const predictBox = document.getElementById('predictTime');
        
        // 週五真正需要工作的時間 = 目標 - (前四天已完成) - (週五請假時數)
        const friLeaveMins = friLeave * 60;
        const neededWorkMins = (TARGET_HOURS*60) - minsBeforeFri - friLeaveMins;

        if (friFullHoliday) {
            predictBox.textContent = "週五放假";
        } else if (neededWorkMins <= 0) {
            predictBox.textContent = "已達標";
        } else if (!friStart) {
            predictBox.textContent = "待輸入";
        } else {
            // 從上班時間往後推 neededWorkMins (需跳過午休)
            let w = 0, c = timeToMin(friStart);
            while(w < neededWorkMins) {
                c++;
                // 如果目前時間不在午休，則算入工作進度
                if(c <= LUNCH_START || c > LUNCH_END) {
                    w++;
                }
            }
            predictBox.textContent = minToTime(c);
        }
    }

    // --- 4. 基礎與儲存 ---
    function initUserSelect() {
        const sel = document.getElementById('userSelect');
        sel.innerHTML = '';
        users.forEach(u => sel.add(new Option(u, u)));
        sel.value = currentUser;
    }
    function switchUser() {
        currentUser = document.getElementById('userSelect').value;
        loadUserData();
    }
    function addNewUser() {
        const n = prompt("新人員名稱:");
        if(n && !users.includes(n)) {
            users.push(n); localStorage.setItem('worklog_users', JSON.stringify(users));
            currentUser = n; initUserSelect(); loadUserData();
        }
    }
    function deleteUser() {
        if(users.length<=1) return alert("無法刪除最後一人");
        if(confirm("刪除此人?")) {
            users = users.filter(u=>u!==currentUser);
            localStorage.setItem('worklog_users', JSON.stringify(users));
            currentUser=users[0]; initUserSelect(); loadUserData();
        }
    }
    function setDefaultDate() {
        const d = new Date();
        const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6 : 1);
        const mon = new Date(d.setDate(diff));
        document.getElementById('weekStartDate').value = mon.toISOString().split('T')[0];
    }
    function timeToMin(s) { return s ? s.split(':').reduce((h,m)=>h*60 + +m) : null; }
    function minToTime(m) { return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }
    function calcNetWork(s, e) {
        if(s>=e) return 0;
        let d = e-s;
        let oS = Math.max(s, LUNCH_START), oE = Math.min(e, LUNCH_END);
        if(oE > oS) d -= (oE-oS);
        return d;
    }

    // 儲存資料 (新增 leave 欄位)
    function saveUserData() {
        const d = document.getElementById('weekStartDate').value;
        const rows = document.querySelectorAll('#timesheetBody tr');
        const data = Array.from(rows).map(r => ({
            s: r.querySelector('.start-time').value,
            e: r.querySelector('.end-time').value,
            l: r.querySelector('.leave-input').value, // 儲存請假時數
            h: r.querySelector('.holiday-check').checked
        }));
        localStorage.setItem(`worklog_${currentUser}_${d}`, JSON.stringify(data));
    }

    // 載入資料
    function loadUserData() {
        const d = document.getElementById('weekStartDate').value;
        const data = JSON.parse(localStorage.getItem(`worklog_${currentUser}_${d}`));
        const rows = document.querySelectorAll('#timesheetBody tr');
        
        if(data) {
            rows.forEach((r,i) => {
                if(data[i]) {
                    r.querySelector('.start-time').value = data[i].s;
                    r.querySelector('.end-time').value = data[i].e;
                    r.querySelector('.leave-input').value = data[i].l || ""; // 讀取請假時數
                    r.querySelector('.holiday-check').checked = data[i].h;
                }
            });
        } else {
            rows.forEach(r => {
                const isHoliday = r.classList.contains('is-holiday');
                r.querySelector('.holiday-check').checked = isHoliday;
                r.querySelector('.start-time').value = "09:00";
                r.querySelector('.end-time').value = (r.id === 'day-4') ? "" : "18:00";
                r.querySelector('.leave-input').value = "";
            });
        }
        calculate();
    }
</script>
</body>
</html>
